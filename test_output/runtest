#!/bin/bash
set -e

# Setup paths
BUILD_DIR="../build"
TEST_DIR="."
MK_EARTH="$BUILD_DIR/milk-streamtelemetry-mkearthseq"
FITS2PNG="$BUILD_DIR/milk-streamtelemetry-3DFITS-to-png"
PCA="$BUILD_DIR/milk-streamtelemetry-pca"

echo "=== Running Test Suite ==="

# 1. Generate Datasets
echo "Generating earthA..."
$MK_EARTH 1000 "$TEST_DIR/earthA[0,0]" -speed 1.0 -size 100 100

echo "Generating earthB..."
$MK_EARTH 1000 "$TEST_DIR/earthB[10,20]" -speed 1.0 -size 100 100

# 2. Visualize Frames
echo "Visualizing Frames..."
$FITS2PNG "$TEST_DIR/earthA.fits" "$TEST_DIR/earthA_frames.png" -n 20 -geom 10x2
$FITS2PNG "$TEST_DIR/earthB.fits" "$TEST_DIR/earthB_frames.png" -n 20 -geom 10x2

# 3. Run PCA
echo "Running PCA on earthA..."
$PCA 20 "$TEST_DIR/earthA.fits" "$TEST_DIR/modesA.fits" "$TEST_DIR/coeffsA.fits" > "$TEST_DIR/pcaA.log"

echo "Running PCA on earthB..."
$PCA 20 "$TEST_DIR/earthB.fits" "$TEST_DIR/modesB.fits" "$TEST_DIR/coeffsB.fits" > "$TEST_DIR/pcaB.log"

# 4. Visualize Modes
# Modes are stored as a 3D cube where Z is the mode index.
echo "Visualizing Modes..."
$FITS2PNG "$TEST_DIR/modesA.fits" "$TEST_DIR/modesA.png" -slices 0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19 -geom 10x2
$FITS2PNG "$TEST_DIR/modesB.fits" "$TEST_DIR/modesB.png" -slices 0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19 -geom 10x2

# 5. Reconstruct from PCA
echo "Reconstructing earthA..."
"$BUILD_DIR/milk-streamtelemetry-recon" "$TEST_DIR/modesA.fits" "$TEST_DIR/coeffsA.fits" "$TEST_DIR/reconA.fits"

echo "Reconstructing earthB..."
"$BUILD_DIR/milk-streamtelemetry-recon" "$TEST_DIR/modesB.fits" "$TEST_DIR/coeffsB.fits" "$TEST_DIR/reconB.fits"

echo "Visualizing Reconstruction..."
$FITS2PNG "$TEST_DIR/reconA.fits" "$TEST_DIR/reconA_frames.png" -n 5 -geom 5x1
$FITS2PNG "$TEST_DIR/reconB.fits" "$TEST_DIR/reconB_frames.png" -n 5 -geom 5x1

# 6. Run CCA
echo "Running CCA between earthA and earthB..."
# Using -npca 40 20 to reduce dimensionality before CCA
"$BUILD_DIR/milk-streamtelemetry-cca" -npca 40 20 "$TEST_DIR/earthA.fits" "$TEST_DIR/earthB.fits"

# CCA outputs ccaA.fits and ccaB.fits (canonical vectors) in the current directory (or where run from?)
# The code writes to "ccaA.fits" and "ccaB.fits" when using -npca.
if [ -f "ccaA.fits" ]; then mv ccaA.fits ccaAvec.fits; fi
if [ -f "ccaB.fits" ]; then mv ccaB.fits ccaBvec.fits; fi

# If we run from TEST_DIR, they will be there.
# Let's ensure they are moved or we run in TEST_DIR.
# Since we are running with $TEST_DIR paths, the C code opens those files.
# But it writes to "ccaA.fits" (hardcoded). So it writes to CWD.
# We are running this script. The CWD is where we invoke it from.
# The previous steps used $TEST_DIR for outputs.
# Let's assume we run this script from its directory or handle the moves.
# The step "$BUILD_DIR/milk-streamtelemetry-cca" will write to CWD.

# Only move if the source and destination are different
for file in ccaAvec.fits ccaBvec.fits ccaAvar.fits ccaBvar.fits; do
    if [ -f "$file" ] && [ ! "$file" -ef "$TEST_DIR/$file" ]; then
        mv "$file" "$TEST_DIR/$file"
    fi
done

echo "Visualizing CCA Vectors..."
$FITS2PNG "$TEST_DIR/ccaAvec.fits" "$TEST_DIR/ccaA_vectors.png" -slices 0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19 -geom 10x2
$FITS2PNG "$TEST_DIR/ccaBvec.fits" "$TEST_DIR/ccaB_vectors.png" -slices 0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19 -geom 10x2

# 7. Generate Report
echo "Generating Report..."
cat <<EOF > "$TEST_DIR/report.md"
# Milk Stream Telemetry Test Report

This report documents the testing of the Earth sequence generation and analysis tools.

## 1. Earth Datasets Generation

Two simulated datasets were generated representing a rotating Earth from different viewpoints.

**Commands:**
\`\`\`bash
# Generate Earth A (View: Lat 0, Lon 0)
$MK_EARTH 1000 "earthA[0,0]" -speed 1.0 -size 100 100

# Generate Earth B (View: Lat 10, Lon 20)
$MK_EARTH 1000 "earthB[10,20]" -speed 1.0 -size 100 100
\`\`\`

### Earth A
![Earth A Frames](earthA_frames.png)

### Earth B
![Earth B Frames](earthB_frames.png)

## 2. PCA Analysis

Principal Component Analysis was performed on both datasets (20 modes).

**Commands:**
\`\`\`bash
# Run PCA
$PCA 20 earthA.fits modesA.fits coeffsA.fits
$PCA 20 earthB.fits modesB.fits coeffsB.fits
\`\`\`

**Note on Mode 0:** The PCA implementation does NOT re-center (de-average) the input data. Therefore, the first mode (Mode 0) represents the average intensity of the dataset.

### Earth A Modes (First 20)
![Earth A Modes](modesA.png)

### Earth B Modes (First 20)
![Earth B Modes](modesB.png)

## 3. PCA Reconstruction

The datasets were reconstructed using the computed modes and coefficients.

**Commands:**
\`\`\`bash
# Reconstruct
$BUILD_DIR/milk-streamtelemetry-recon modesA.fits coeffsA.fits reconA.fits
$BUILD_DIR/milk-streamtelemetry-recon modesB.fits coeffsB.fits reconB.fits
\`\`\`

### Earth A Reconstruction
![Earth A Reconstruction](reconA_frames.png)

### Earth B Reconstruction
![Earth B Reconstruction](reconB_frames.png)

## 4. CCA Analysis

Canonical Correlation Analysis was performed between Earth A and Earth B, using the top 40 PCA modes for data reduction and computing 20 canonical vectors.

**Commands:**
\`\`\`bash
# Run CCA (20 vectors, using top 40 PCA modes)
$BUILD_DIR/milk-streamtelemetry-cca -npca 40 20 earthA.fits earthB.fits
\`\`\`

### Earth A Canonical Vectors (First 20)
![Earth A CCA](ccaA_vectors.png)

### Earth B Canonical Vectors (First 20)
![Earth B CCA](ccaB_vectors.png)

## 5. Visualization Commands

The PNG images in this report were generated using the \`3DFITS-to-png\` tool:

\`\`\`bash
# Visualize Frames
$FITS2PNG earthA.fits earthA_frames.png -n 20 -geom 10x2
$FITS2PNG earthB.fits earthB_frames.png -n 20 -geom 10x2

# Visualize Modes
$FITS2PNG modesA.fits modesA.png -slices 0..19 -geom 10x2
$FITS2PNG modesB.fits modesB.png -slices 0..19 -geom 10x2

# Visualize Reconstruction
$FITS2PNG reconA.fits reconA_frames.png -n 5 -geom 5x1
$FITS2PNG reconB.fits reconB_frames.png -n 5 -geom 5x1

# Visualize CCA
$FITS2PNG ccaAvec.fits ccaA_vectors.png -slices 0..19 -geom 10x2
$FITS2PNG ccaBvec.fits ccaB_vectors.png -slices 0..19 -geom 10x2
\`\`\`

EOF

# 8. Generate Plots (CCA and PCA Variables)
echo "Generating Variable Plots..."

# --- CCA ---
# Convert FITS variables to ASCII
"$BUILD_DIR/milk-streamtelemetry-fits2ascii" "$TEST_DIR/ccaAvar.fits" > "$TEST_DIR/ccaAvar.txt"
"$BUILD_DIR/milk-streamtelemetry-fits2ascii" "$TEST_DIR/ccaBvar.fits" > "$TEST_DIR/ccaBvar.txt"
paste "$TEST_DIR/ccaAvar.txt" "$TEST_DIR/ccaBvar.txt" > "$TEST_DIR/cca_vars.dat"

# --- PCA ---
# Convert FITS coefficients to ASCII
"$BUILD_DIR/milk-streamtelemetry-fits2ascii" "$TEST_DIR/coeffsA.fits" > "$TEST_DIR/coeffsA.txt"
"$BUILD_DIR/milk-streamtelemetry-fits2ascii" "$TEST_DIR/coeffsB.fits" > "$TEST_DIR/coeffsB.txt"
paste "$TEST_DIR/coeffsA.txt" "$TEST_DIR/coeffsB.txt" > "$TEST_DIR/pca_vars.dat"

# Gnuplot Template Function
# Arguments: 1=DataFile, 2=OutputFile, 3=Title, 4=VarNameA, 5=VarNameB
generate_plot() {
    DATA_FILE="$1"
    OUT_FILE="$2"
    TITLE="$3"
    VAR_A="$4"
    VAR_B="$5"
    SCRIPT_FILE="${OUT_FILE%.*}.gp"

    cat <<ENDGP > "$SCRIPT_FILE"
set terminal pngcairo size 2000,2000 enhanced font "Arial,8"
set output "$OUT_FILE"

# Define style for boxed labels
set style textbox opaque noborder
set style fill solid 1.0 noborder

# Use margins to leave space for outer labels, spacing 0,0 to touch plots
set multiplot layout 20,20 rowsfirst title "$TITLE" margins 0.04, 0.96, 0.04, 0.94 spacing 0,0

# Pre-calculate standard deviations
array stdA[20]
array stdB[20]
do for [k=1:20] {
    stats "$DATA_FILE" u k nooutput
    stdA[k] = STATS_stddev
    stats "$DATA_FILE" u (k+20) nooutput
    stdB[k] = STATS_stddev
}

do for [j=0:19] {
    do for [i=0:19] {
        colA = i + 1
        colB = j + 21

        # Calculate Correlation
        stats "$DATA_FILE" u colA:colB nooutput
        corr = STATS_correlation

        # Reset labels
        unset label

        # Correlation Label (Top Right): Bold Red, White Box
        # Using a simpler label for density
        if (abs(corr) > 0.1) {
            set label 1 sprintf("%.1f", corr) at graph 0.90, 0.90 right font "Arial-Bold,7" textcolor rgb "red" front boxed
        }

        # Standard Deviation Labels
        # Top of Column
        if (j == 0) {
            set label 2 sprintf("σA%d\\n%.1g", i, stdA[i+1]) at graph 0.5, 1.05 center font "Arial,7"
        }
        # Right of Row
        if (i == 19) {
            set label 3 sprintf("σB%d\\n%.1g", j, stdB[j+1]) at graph 1.05, 0.5 left font "Arial,7"
        }

        # Axis Labels (Outer Only)
        set format x ""
        set format y ""
        unset xlabel
        unset ylabel
        unset xtics
        unset ytics

        # Restore tics structure but no values (or remove ticks completely?)
        # User said "remove the values on the x and y axes ticks", imply ticks might remain?
        # But for corner plot usually inner ticks are removed.
        # Let's keep ticks but remove format as requested.
        set tics scale 0.5

        if (j == 19) { set xlabel sprintf("$VAR_A%d", i) font "Arial,8" }
        if (i == 0) { set ylabel sprintf("$VAR_B%d", j) offset 1 font "Arial,8" }

        unset key
        # Make plots square-ish? 'set size square' can mess with layout filling.
        # With spacing 0,0, layout determines size. 'set size ratio 1' might create gaps.
        # Let's rely on layout.

        # Zero Cross
        set xzeroaxis lt 1 lc rgb "black"
        set yzeroaxis lt 1 lc rgb "black"

        plot "$DATA_FILE" using colA:colB pt 7 ps 0.2 lc rgb "black"
    }
}
unset multiplot
ENDGP

    gnuplot "$SCRIPT_FILE"
}

generate_plot "$TEST_DIR/cca_vars.dat" "$TEST_DIR/cca_corner.png" "CCA Variables (A vs B)" "A" "B"
generate_plot "$TEST_DIR/pca_vars.dat" "$TEST_DIR/pca_corner.png" "PCA Variables (Coeffs A vs B)" "A" "B"

# 9. Append Covariance Matrix
echo "Calculating Covariance Matrix..."
echo "" >> "$TEST_DIR/report.md"
echo "## 8. Covariance Matrix of Canonical Variables" >> "$TEST_DIR/report.md"
echo "" >> "$TEST_DIR/report.md"
echo "The following table shows the covariance between canonical variables $A_i$ and $B_j$." >> "$TEST_DIR/report.md"
echo "" >> "$TEST_DIR/report.md"
"$BUILD_DIR/milk-streamtelemetry-verify-corr" -cov "$TEST_DIR/ccaAvar.fits" "$TEST_DIR/ccaBvar.fits" >> "$TEST_DIR/report.md"

# Append to report
cat <<EOF >> "$TEST_DIR/report.md"

## 6. CCA variables

Scatter plots of canonical variables $A_i$ vs $B_j$. The diagonal ($i=j$) should show the strongest correlations.
Correlation $r$ is shown on each plot. $\sigma$ values indicate standard deviation of the variables.

![CCA Variables](cca_corner.png)

### CCA Gnuplot Script
\`\`\`gnuplot
$(cat "$TEST_DIR/cca_corner.gp")
\`\`\`

## 7. PCA variables

Scatter plots of PCA coefficients $A_i$ vs $B_j$.

![PCA Variables](pca_corner.png)

### PCA Gnuplot Script
\`\`\`gnuplot
$(cat "$TEST_DIR/pca_corner.gp")
\`\`\`

EOF

echo "Test Complete. Results in $TEST_DIR"
